name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: 948881762705.dkr.ecr.us-east-1.amazonaws.com
  ECR_REPOSITORY: idp-test-approval
  IMAGE_TAG: ${{ github.sha }}
  MANIFESTS_PATH: deploy
  PLATFORMS: linux/arm64
  APP_NAME: test-approval
  DOMAIN: timedevops.click

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::948881762705:role/github-actions-ecr-push
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Create ECR repository if not exists
        run: |
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region $AWS_REGION || \
          aws ecr create-repository \
            --repository-name $ECR_REPOSITORY \
            --region $AWS_REGION \
            --image-scanning-configuration scanOnPush=true \
            --tags Key=managed-by,Value=backstage Key=app,Value=test-approval

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate build configuration
        run: |
          echo "Build platforms: $PLATFORMS"
          docker buildx ls

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: ${{ env.PLATFORMS }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }}
            ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-deploy-pr:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Kubernetes manifest
        run: |
          sed -i "s|image: .*|image: $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" "$MANIFESTS_PATH/deployment.yaml"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: deploy/${{ github.sha }}
          delete-branch: true
          title: "Deploy: test-approval @ ${{ github.sha }}"
          body: |
            ## Deployment Request

            **Application:** `test-approval`
            **Image:** `${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}`
            **Triggered by:** @${{ github.actor }}
            **Commit:** ${{ github.sha }}

            ### Pre-deploy Checklist
            - [x] Image build passed
            - [x] Image pushed to ECR
            - [ ] Reviewer approved

            ### Links
            - [CI Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [ArgoCD App](https://argocd.${{ env.DOMAIN }}/applications/${{ env.APP_NAME }})
            - [Backstage Component](https://backstage.${{ env.DOMAIN }}/catalog/default/component/${{ env.APP_NAME }})

            ---
            *Auto-generated by CI Pipeline*
          labels: |
            deployment
            automated
            needs-review
